{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block body %}
    <link rel="stylesheet" type="text/css" href="/static/search.css" />
    <script src="/static/snorlax.js"></script>
    <h1>Hateabase</h1>
    <h3>This website can be used to get statistics about hate crimes commited in the US based on the FBI dataset from 2014.</h3>
    <h2>Get statistics about:</h2>
    <form name="getter">
        <input type="hidden" value=0 name="id" />
        <select name="get-choice" id="get-chooser">
            <option value="">Get</option>
            {% for obj in api %}
                <option value="{{ obj.val }}">{{ obj.title }}</option>
            {% endfor %}
        </select>
    </form>
    {% for obj in api %}
        <form name="by-{{ obj.val }}">
            <input type="hidden" value=1 name="id" />
            <select name="by-choice-{{ obj.val }}" id="by-chooser-{{ obj.val }}">
                <option value="">By</option>
                {% for data in obj.attributes %}
                    <option value="{{ data.val }}">{{ data.title }}</option>
                {% endfor %}
            </select>
        </form>
    {% endfor %}
    <button id="sender">Query</button>
    <table id="results" class="empty">
    </table>
    <script type="text/javascript">
        var snore = new snorlax('http://localhost:5000/hateabase/api/v1.0');
        $("button#sender").click(function() {
            snore.find($("select#get-chooser").val(), $("select#by-chooser-" + $("select#get-chooser").val()).val(), "", function(json, status, xhr){
                console.log(xhr.status);
                if (xhr.status === 200) {
                    var results = $("table#results");
                    data = json['data'];
                    keys = json['keys'];

                    var htm = ""
                    
                    htm += "<tr>"
                        keys.forEach(function(val, key, keyList) {
                            htm += "<td>" + val + "</td>";
                        });
                        htm += "</tr>"
                    data.forEach(function(dict, index, dataList) {
                        htm += "<tr>"
                        keys.forEach(function(val, key, keyList) {
                            htm += "<td>" + dict[val] + "</td>";
                        });
                        htm += "</tr>"
                    });
                    results.html(htm);

                    if (results.hasClass("empty")) {
                        results.removeClass("empty");
                    }
                } else {
                    results.addClass("empty");
                }
            });
        });
    </script>
{% endblock %}